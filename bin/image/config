#!/bin/bash

dir=$(/bin/readlink -f $(/usr/bin/dirname $0))
name=$1
address=$2
if [ -z $name ]
then
    echo "usage: image/config <machine_name> <ip_address>" 1>&2
    exit 1
fi


/usr/bin/sudo /bin/mkdir -p /mnt/config/var/$name/etc/ssh

KEYGEN=/usr/bin/ssh-keygen
RSA_KEY=/mnt/config/var/$name/etc/ssh/ssh_host_rsa_key
if [ ! -s $RSA_KEY ]; then
    rm -f $RSA_KEY
    if test ! -f $RSA_KEY && /usr/bin/sudo $KEYGEN -q -t rsa -f $RSA_KEY -C '' -N '' >&/dev/null; then
        /usr/bin/sudo /bin/chmod 600 $RSA_KEY
        /usr/bin/sudo /bin/chmod 644 $RSA_KEY.pub
        if [ -x /sbin/restorecon ]; then
            /usr/bin/sudo /sbin/restorecon $RSA_KEY.pub
        fi
        echo
    else
        echo
        exit 1
    fi
fi

function append_unless()
{
    local line=$1
    grep "$line" /mnt/dns/var/runpup.com/runpup.com.zone 
    if [ $? -ne 0 ]
    then
        echo "$line"
        echo "$line" | /usr/bin/sudo /usr/bin/tee -a /mnt/dns/var/runpup.com/runpup.com.zone > /dev/null
    fi
}

/usr/bin/sudo /bin/mkdir -p /mnt/config/var/$name/etc/sysconfig
cat <<HERE | /usr/bin/sudo /usr/bin/tee /mnt/config/var/$name/etc/sysconfig/network > /dev/null
NETWORKING=yes
NETWORKING_IPV6=no
HOSTNAME=$name
HERE

if [ ! -z "$address" ]
then
    host=$(echo $name | sed 's/\.runpup\.com//')
    append_unless "$(ssh-keygen -r $host -f $RSA_KEY)"
    append_unless "$host IN A $address"
fi
