#!/bin/bash

function make_group()
{
    group=$1
    gid=$2
    cut -d: -f1 /etc/group | grep '^'$group'$' > /dev/null
    ret=$?
    if [ $ret != 0 ]
    then
        echo "Creating group $group."
        /usr/bin/sudo /usr/sbin/groupadd --gid $gid $group
    else
        echo "Group $group exists."
    fi
}

function make_user()
{
    user=$1
    uid=$2
    gid=$3
    cut -d: -f1 /etc/passwd | grep '^'$user'$' > /dev/null
    ret=$?
    if [ $ret != 0 ]
    then
        echo "Creating user $user."
        /usr/bin/sudo /usr/sbin/useradd --uid $uid --gid $gid $user --groups wheel
    else
        echo "User $user exists."
    fi
}

# Create the development user.
make_group $user 701
make_user $user 701 701

if [ ! -e /home/$user/.ssh/authorized_keys ]
then
    /usr/bin/sudo -u $user /bin/mkdir -m 755 -p /home/$user/.ssh
    /bin/cp -p /root/.ssh/authorized_keys /home/$user/.ssh/
    /bin/chown $user:$user /home/$user/.ssh/authorized_keys
fi

if [ ! -e /home/$user/git/ecma/puppy/system ]
then
    /usr/bin/sudo -u $user /bin/mkdir -p /home/$user/git/ecma/puppy
    /usr/bin/sudo -E -u $user /usr/bin/git clone git@bled.prettyrobots.com:etc.git /home/$user/etc
fi
