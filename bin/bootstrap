#!/bin/bash

user=$1

if [ -z $user ]
then
    echo "User name for primary user required." 1>&2
    exit 1
fi

function make_group()
{
    group=$1
    gid=$2
    cut -d: -f1 /etc/group | grep '^'$group'$' > /dev/null
    ret=$?
    if [ $ret != 0 ]
    then
        echo "Creating group $group."
        /usr/bin/sudo /usr/sbin/groupadd --gid $gid $group
    else
        echo "Group $group exists."
    fi
}

function make_user()
{
    user=$1
    uid=$2
    gid=$3
    cut -d: -f1 /etc/passwd | grep '^'$user'$' > /dev/null
    ret=$?
    if [ $ret != 0 ]
    then
        echo "Creating user $user."
        /usr/bin/sudo /usr/sbin/useradd --uid $uid --gid $gid $user --groups wheel
    else
        echo "User $user exists."
    fi
}

# Create the development user.
make_group $user 701
make_user $user 701 701

if [ ! -e /home/$user/.ssh/authorized_keys ]
then
    /usr/bin/sudo -u $user /bin/mkdir -m 755 -p /home/$user/.ssh
    /bin/cp -p /root/.ssh/authorized_keys /home/$user/.ssh/
    /bin/chown $user:$user /home/$user/.ssh/authorized_keys
fi

if [ ! -e /home/$user/git/ecma/puppy/system ]
then
    echo "StrictHostKeyChecking no" > /home/alan/.ssh/config
    /usr/bin/sudo -u $user /bin/mkdir -p /home/$user/git/ecma/puppy
    /usr/bin/ssh -o ForwardAgent=yes -o NoHostAuthenticationForLocalhost=yes -l $user localhost /usr/bin/git clone -b system git@bled.prettyrobots.com:puppy.git /home/$user/git/ecma/puppy/system
    /bin/rm /home/alan/.ssh/config
fi

cat<<EOL > /root/wheel
%wheel	ALL=(ALL)	NOPASSWD: ALL
EOL

/bin/chmod 440 /root/wheel
/bin/mv /root/wheel /etc/sudoers.d/

# Recreate grub.conf with selinux on.
cat <<EOL > /boot/grub/grub.conf

default=0
timeout=10
title Fedora 13
        root (hd0,0)
        kernel /boot/vmlinuz ro root=/dev/sda1 rd_NO_PLYMOUTH
        initrd /boot/initramfs
EOL

/bin/chmod 600 /boot/grub/grub.conf

/usr/bin/yum install -y selinux-policy-targeted

touch /.autorelabel 

/usr/sbin/semodule -B
