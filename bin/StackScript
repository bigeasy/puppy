#!/bin/sh
# <UDF NAME="PUBLIC_KEY" LABEL="Public SSH Key" />

# Create a new instance using a StackScript. It will initialize using the
# default Fedora 13 configuration. Boot that and it will run this. Then reboot
# using pv-grub-x86_32 as the kernel. You'll be able to login as root through
# ssh using the root password. Continue building from there.

# My system IP/set ip address of server
SERVER_IP=`ifconfig | grep 'inet addr:' | grep -v '127.0.0.1' | sed 's/.*inet addr:\([0-9.]\+\).*/\1/g'`

echo $SERVER_IP

# Flushing all rules
iptables -F
iptables -X
# Setting default filter policy
iptables -P INPUT DROP
iptables -P OUTPUT ACCEPT
iptables -P FORWARD DROP
# Allow unlimited traffic on loopback
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Allow incoming ssh only

iptables -A INPUT -p tcp -s 0/0 -d $SERVER_IP --sport 513:65535 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -s $SERVER_IP -d 0/0 --sport 22 --dport 513:65535 -m state --state ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT

service iptables save

yum -y update
yum -y groupinstall core
yum -y install kernel-PAE.i686

touch /.autorelabel

vmlinuz=`ls /boot/vmlinuz-*`
initramfs=`ls /boot/initramfs-*`
kernel=`ls /boot/vmlinuz-* | sed 's/\/boot\/vmlinuz-//'`

cat <<HERE > /boot/grub/menu.lst
timeout 0

title           Fedora 13, kernel $kernel
root            (hd0)
kernel          $vmlinuz root=/dev/xvda ro quiet
initrd          $initramfs
HERE

/bin/mkdir -p /root/.ssh
echo "$PUBLIC_KEY" > /root/.ssh/authorized_keys
/bin/chmod 600 /root/.ssh/authorized_keys

cat <<HERE > /root/continue
#!/bin/bash

/usr/bin/scp alan@portoroz.prettyrobots.com:/home/alan/git/ecma/puppy/system/bin/bootstrap /root/bootstrap
/usr/bin/scp alan@portoroz.prettyrobots.com:/home/alan/git/ecma/puppy/system/bin/rpms.txt /root/rpms.txt
/bin/chmod 755 /root/bootstrap
HERE

/bin/chmod 755 /root/continue

/sbin/shutdown -h now
