#!/bin/bash

# You can run as root by via `sudo -H -u janitor mysql -u root`. This runs as
# the janitor user and `-H` sets the home directory.

user=$(whoami)
if [ $user != "root" ]
then
    echo "Must run as root." 2>&1
    exit 1
fi

password=$(ps ax | md5sum | cut -c 1-32)

MYSQL_OPTS=""

if [ -e /home/janitor/.my.cnf ]; then
    MYSQL_OPTS="--defaults-file=/home/janitor/.my.cnf"
fi

echo 'update user set password=PASSWORD("'$password'") where User='"'root'"';' | \
    /usr/bin/mysql $MYSQL_OPTS --user=root mysql
if [ $? -ne 0 ]; then
    echo "MySQL update of root password failed." 1>&2 
    exit 1
fi

/bin/rm -f /home/janitor/.my.cnf
/bin/touch /home/janitor/.my.cnf
/bin/chown janitor:janitor /home/janitor/.my.cnf 
/bin/chmod 400 /home/janitor/.my.cnf 

echo "[client]" >> /home/janitor/.my.cnf
echo "password=$password" >> /home/janitor/.my.cnf

/sbin/service mysqld restart
