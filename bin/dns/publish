#!/bin/bash

dir=$(/bin/readlink -f "$(/bin/readlink -f $(/usr/bin/dirname $0))/..")

function advance_serial()
{
    local file=$1;
    if [ ! -e $file ]
    then
        "Does not exist: $file."
    fi
    today=$(/bin/date +%Y%m%d)
    current=($(/bin/sed -n 's/.*\([0-9]\{8\}\)\([0-9]\{2\}\).*; Serial.*/\1 \2/p' $file))
    if [ "${current[0]}" == "$today" ]
    then
        next="${today}"$(/usr/bin/printf '%02d\n' $((10#${current[1]} + 1)))
    else
        next="${today}01"
    fi
    /bin/sed -i 's/\(.*\)[0-9]\{10\}\(.*; Serial.*\)/\1'$next'\2/' $file
    echo $next
}

for zone in $@
do
    domain=$(echo $zone | /bin/sed 's/.*\.\(.*\..*\)/\1/') 
    advance_serial /mnt/dns/var/$domain/$zone.zone
done

for zone in runpup.com virginia.runpup.net prettyrobots.com
do
    domain=$(echo $zone | /bin/sed 's/.*\.\(.*\..*\)/\1/') 
    path=/mnt/dns/var/$domain
    ksk=$(/bin/basename $(/bin/ls $path/current/ksk/*.key) .key)
    zsk=$(/bin/basename $(/bin/ls $path/current/zsk/*.key) .key)
    /usr/bin/ldns-signzone $path/$zone.zone $path/current/ksk/$ksk $path/current/zsk/$zsk
    /usr/bin/sudo /bin/cp $path/$zone.zone.signed /var/lib/nsd/chroot/etc/nsd/
done

/usr/bin/sudo /bin/chown -R nsd:nsd /var/lib/nsd/chroot
/usr/bin/sudo /bin/chmod -R gou+x /var/lib/nsd/chroot
/usr/bin/sudo /bin/chmod -R o-rwx /var/lib/nsd/chroot
/usr/bin/sudo /usr/sbin/nsdc rebuild
/usr/bin/sudo /usr/sbin/nsdc reload
/usr/bin/sudo /usr/sbin/nsdc notify

#$dir/loopback/snapshot /mnt/dns
