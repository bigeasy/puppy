#!/bin/bash

user=$(whoami)
if [ $user != "root" ]
then
    echo "Must run as root." 2>&1
    exit 1
fi

echo "show databases" | /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root | /bin/sed 1d | /bin/grep '^'puppy'$' > /dev/null
if [ $? -ne 0 ]
then
    echo "CREATE DATABASE puppy" | \
        /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root
fi

password=$(ps ax | md5sum | cut -c 1-32)

/bin/rm -f /home/database/configuration
/bin/touch /home/database/configuration
/bin/chown database:database /home/database/configuration
/bin/chmod 400 /home/database/configuration
echo "$(/bin/hostname) $password" >> /home/database/configuration

echo "GRANT ALL PRIVILEGES ON puppy.* TO 'puppy'@'localhost' IDENTIFIED BY '"$password"'" | \
    /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root

/sbin/restorecon -R /home/database
