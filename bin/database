#!/bin/bash

user=$(whoami)
if [ $user != "root" ]
then
    echo "Must run as root." 2>&1
    exit 1
fi

echo "show databases" | /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root | /bin/sed 1d | /bin/grep '^'puppy'$'
if [ $? -eq 0 ]
then
    echo "Database puppy already exists." 2>&1
    exit 1
fi

echo "CREATE DATABASE puppy" | \
    /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root

password=$(ps ax | md5sum | cut -c 1-32)

/bin/rm -f /home/database/password
/bin/touch /home/database/password
/bin/chown database:database /home/database/password
/bin/chmod 400 /home/database/password
echo $password >> /home/database/password

echo "GRANT ALL PRIVILEGES ON puppy.* TO 'puppy'@'localhost' IDENTIFIED BY '"$password"'" | \
    /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root

/sbin/restorecon -R /home/database
