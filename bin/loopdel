#!/bin/bash

function abend()
{
    local message=$1
    echo "error: $message" 1>&2
    exit 1
}

mnt=$1
[ -d $mnt ] || abend "No such directory."
path=$(/bin/readlink -f $mnt)

device=$(/bin/mount | awk '$3 == "'$path'" { print $1 }')
[ -z "$device" ] && abend "Not a mounted loopback device."

image=$(/usr/bin/sudo /sbin/losetup --show $device | /bin/sed 's/.*(\(.*\))/\1/')

/usr/bin/sudo /bin/umount $path
/usr/bin/sudo /sbin/losetup -d $device
/usr/bin/sudo /usr/bin/srm -f $image
/usr/bin/sudo /bin/rmdir $path
