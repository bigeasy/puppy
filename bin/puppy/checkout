#!/bin/bash

dir=$(/bin/readlink -f "$(/usr/bin/dirname $0)/../../..")

cd $dir/github

function abend()
{
    local message=$1
    echo $message 1>&2
    exit 1
}

branches=(janitor common private protected public system worker appliances \
    vhosts database client liminal exclusive job)

if [ ! -e $dir/github ]
then
    cd $dir
    /usr/bin/git clone git@github.com:bigeasy/puppify.git github
fi

cd $dir/github
/usr/bin/git fetch --all

for branch in "${branches[@]}"; do
    /usr/bin/git checkout $branch 
    git rebase origin/$branch || abend "Cannot rebase $branch."
done

for branch in "${branches[@]}"; do
    if [ ! -e $dir/$branch ]
    then
        cd $dir
        /usr/bin/git clone -b $branch $dir/github $branch
        cd $dir/$branch
        /usr/bin/git remote add github git@github.com:bigeasy/puppify.git
    fi
done

for branch in "${branches[@]}"; do
    cd $dir/$branch
    if [ "$(/usr/bin/git branch | /bin/grep '^*' | /bin/cut -f2 -d' ')" == "$branch" ]
    then
        /usr/bin/git pull
    else
        echo "Sub-project $branch is on a development branch."
    fi
done
