#!/bin/bash

if [ $(/usr/bin/id -u) -ne 0 ]
then
    echo "Must run as root." 1>&2
    exit 1
fi

dir=$(/bin/readlink -f "$(/usr/bin/dirname $0)/../../..")

hostname=$(/bin/hostname)
[[ $hostname =~ ^([^.]*)\.[^.]*\.([^.]*)\.([^.]*)\..*$ ]] || abend "bad hostname"
alpha=${BASH_REMATCH[1]}; direction=${BASH_REMATCH[2]}; region=${BASH_REMATCH[3]};  

if [ ! -z "$1" ]
then
    direction=$1
fi

host="$alpha.data.$direction.$region.runpup.net"
declare -A AXES
AXES=([north]=vertical [south]=vertical [east]=horizontal [west]=horizontal)
ip=$($dir/var/bin/dns/private/address --region $region --axis ${AXES[$direction]} | while read line
do
    pair=($line)
    if [ ${pair[0]} == $hostname ]
    then
        echo ${pair[1]}
    fi
done)

cat <<EOL > /etc/haproxy/postgresql.cfg
global
    log         /dev/log local2 
    log-tag     hapostgresql
#    chroot      /var/lib/haproxy
    pidfile     /var/run/hapostgresql.pid
    maxconn     250
    user        haproxy
    group       haproxy
    daemon
    #stats socket /var/lib/haproxy/stats
defaults
    mode                    tcp
    log                     global
    option                  tcplog
    retries                 3
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout check           10s
    maxconn                 250
frontend  postgresql-in
    mode        tcp
    bind                        $ip:5432
    default_backend             postgresql-out
backend postgresql-out
    mode        tcp
    retries 	300             # Five minutes to come back up.
    balance     roundrobin
    server  	postgresql1 	$host:5432  
EOL
