#!/bin/bash

count=$1

if [ -z "$count" ]
then
    count=12
fi

user=$(whoami)
if [ $user != "root" ]
then
    echo "Must run as root." 2>&1
    exit 1
fi

hostname=$(/bin/hostname)
if [ $hostname != "dvor.prettyrobots.com" ]; then
    echo "Where are you trying to run this?" 2>&1
    exit 1
fi

function psql_command()
{
    echo $1 | /usr/bin/sudo -u postgres /usr/bin/psql > /dev/null
}

function psql_script()
{
    /usr/bin/sudo -u puppy /usr/bin/psql -d puppy < $1 > /dev/null
}

/usr/bin/sudo /bin/systemctl stop worker.service

psql_command "DROP DATABASE puppy"
psql_command "CREATE DATABASE puppy"
psql_script ddl/0001_create_database.sql 
psql_script ddl/0002_populate.sql 

bin/load_ports | /usr/bin/sudo -u puppy /usr/bin/psql puppy 

NODE_PATH=/opt/lib/node_modules:/puppy/common/lib/node:/puppy/exclusive/lib/node

/usr/bin/sudo /puppy/janitor/bin/user_generate $count

/puppy/janitor/bin/job $(/bin/hostname) port:unlabel
/puppy/janitor/bin/job $(/bin/hostname) policy:unload
/puppy/janitor/bin/job $(/bin/hostname) policy:generate
/puppy/janitor/bin/job $(/bin/hostname) policy:make
/puppy/janitor/bin/job $(/bin/hostname) policy:load
/puppy/janitor/bin/job $(/bin/hostname) port:label
/puppy/janitor/bin/job $(/bin/hostname) policy:ready

/usr/bin/sudo /bin/systemctl start worker.service

for db in $(echo "SHOW DATABASES" | /usr/bin/sudo -u postgres /usr/bin/psql | grep '^d[0-9]\+')
do
    echo "DROP DATABASE $db" #| /usr/bin/sudo -u janitor -H /puppy/janitor/bin/janitor_mysql -u root puppy
done
