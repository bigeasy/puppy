#!/bin/bash

user=$(whoami)
if [ $user != "root" ]
then
    echo "Must run as root." 2>&1
    exit 1
fi

function mysql_command()
{
    echo $1 | /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root
}

function mysql_script()
{
    /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root puppy < $1
}

/usr/bin/sudo /sbin/initctl stop worker

mysql_command "drop database puppy"
mysql_command "create database puppy"
mysql_script ddl/0001_create_user.sql 
mysql_script ddl/0002_insert_account.sql 

bin/load_ports | sudo -H -u janitor mysql -u root puppy

/usr/bin/sudo -u delegate /puppy/bin/user_generate 3

/puppy/bin/job $(/bin/hostname) port:unlabel
/puppy/bin/job $(/bin/hostname) policy:unload
/puppy/bin/job $(/bin/hostname) policy:generate
/puppy/bin/job $(/bin/hostname) policy:make
/puppy/bin/job $(/bin/hostname) policy:load
/puppy/bin/job $(/bin/hostname) port:label
/puppy/bin/job $(/bin/hostname) policy:ready

/usr/bin/sudo /sbin/initctl start worker
