#!/bin/bash

count=$1

if [ -z "$count" ]
then
    count=12
fi

user=$(whoami)
if [ $user != "root" ]
then
    echo "Must run as root." 2>&1
    exit 1
fi

hostname=$(/bin/hostname)
if [ $hostname != "dvor.prettyrobots.com" ]; then
    echo "Where are you trying to run this?" 2>&1
    exit 1
fi

function mysql_command()
{
    echo $1 | /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root
}

function mysql_script()
{
    /usr/bin/sudo -H -u janitor /usr/bin/mysql -u root puppy < $1
}

/usr/bin/sudo /sbin/initctl stop worker

mysql_command "drop database puppy"
mysql_command "create database puppy"
mysql_script ddl/0001_create_user.sql 
mysql_script ddl/0002_insert_account.sql 
mysql_script ddl/0003_property.sql
mysql_script ddl/0004_set_application_host.sql
mysql_script ddl/0005_domain.sql
mysql_script ddl/0006_application_local_user_ready.sql
mysql_script ddl/0007_account_ready.sql

bin/load_ports | sudo -H -u janitor mysql -u root puppy

NODE_PATH=/opt/lib/node_modules:/puppy/common/lib/node:/puppy/exclusive/lib/node

/usr/bin/sudo /puppy/janitor/bin/user_generate $count

/puppy/janitor/bin/job $(/bin/hostname) port:unlabel
/puppy/janitor/bin/job $(/bin/hostname) policy:unload
/puppy/janitor/bin/job $(/bin/hostname) policy:generate
/puppy/janitor/bin/job $(/bin/hostname) policy:make
/puppy/janitor/bin/job $(/bin/hostname) policy:load
/puppy/janitor/bin/job $(/bin/hostname) port:label
/puppy/janitor/bin/job $(/bin/hostname) policy:ready

/usr/bin/sudo /sbin/initctl start worker

for db in $(echo "SHOW DATABASES" | /usr/bin/sudo -u janitor -H /puppy/janitor/bin/janitor_mysql -u root puppy | grep '^d[0-9]\+')
do
    echo "DROP DATABASE $db" | /usr/bin/sudo -u janitor -H /puppy/janitor/bin/janitor_mysql -u root puppy
done
