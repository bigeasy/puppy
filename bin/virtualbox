#!/bin/bash

# https://github.com/dazed1/pvgrub2ebs/raw/master/createfedora13bootebs.sh

# Start by creating a partition and then running `sudo mkfs.ext4 /dev/sdb1`.

user=$1

if [ $user"x" == "x" -o ! -e /home/$user ]
then
    user=$SUDO_USER
fi

if [ $user"x" == "x" -o ! -e /home/$user ]
then
    echo "Please provide a user used to copy the authorized keys" 1>&2
    exit 1
fi

if [ $(whoami) != "root" ]
then
    echo "Must run as root."
    exit 1
fi

if [ ! -e /mnt/chroot ]
then
    /bin/mkdir /mnt/chroot
fi

/bin/mount | cut -d' ' -f1 | grep /dev/sdb1 > /dev/null
if [ $? -ne 0 ]
then
    /bin/mount /dev/sdb1 /mnt/chroot
fi

/bin/mkdir -p /mnt/chroot/dev
/bin/mkdir -p /mnt/chroot/dev/pts
/bin/mkdir -p /mnt/chroot/dev/shm
/bin/mkdir -p /mnt/chroot/proc
/bin/mkdir -p /mnt/chroot/sys

/bin/mount --bind /dev /mnt/chroot/dev
/bin/mount --bind /dev/pts /mnt/chroot/dev/pts
/bin/mount --bind /dev/shm /mnt/chroot/dev/shm
/bin/mount --bind /proc /mnt/chroot/proc
/bin/mount --bind /sys /mnt/chroot/sys

cat <<EOL > /tmp/yumec2.conf
[main]
cachedir=/var/cache/yum
debuglevel=2
logfile=/var/log/yum.log
exclude=*-debuginfo
gpgcheck=0
obsoletes=1
reposdir=/dev/null

[base]
name=Fedora 13 – i386 – Base
mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-13&arch=i386
enabled=1

[updates-released]
name=Fedora 13 – i386 – Released Updates
mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=updates-released-f13&arch=i386
enabled=1
EOL

dirname=$(dirname $0)
cat "$dirname/rpms.txt" | xargs sudo yum -c /tmp/yumec2.conf --installroot=/mnt/chroot -y install 

/usr/sbin/chroot /mnt/chroot chkconfig --level 2345 network on
/usr/sbin/chroot /mnt/chroot chkconfig --level 2345 sshd on

cat <<EOL > /mnt/chroot/etc/sysconfig/network-scripts/ifcfg-eth0
# Intel Corporation 82540EM Gigabit Ethernet Controller
DEVICE=eth0
TYPE=Ethernet
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth0"
ONBOOT=yes
PEERDNS=yes
PEERROUTES=yes
EOL

cat <<EOL > /mnt/chroot/etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
ONBOOT=yes
IPADDR=192.168.56.14
NETMASK=255.255.255.0
EOL

cat <<EOL > /mnt/chroot/etc/sysconfig/network
NETWORKING=yes
HOSTNAME=dvor.virtualbox
EOL
# here's the trick...what should /boot look like?  answer: plain as hell
cat <<EOL > /mnt/chroot/boot/grub/grub.conf

default=0
timeout=10
title Fedora 13
        root (hd0,0)
        kernel /boot/vmlinuz ro root=/dev/sda1 rd_NO_PLYMOUTH selinux=0
        initrd /boot/initramfs
EOL

/bin/chmod 600 /mnt/chroot/boot/grub/grub.conf

kern=`ls /mnt/chroot/boot/vm*i686|awk -F/ '{print $NF}'`
ird=`ls /mnt/chroot/boot/ini*i686.img|awk -F/ '{print $NF}'`

sed -ie "s/vmlinuz/$kern/" /mnt/chroot/boot/grub/grub.conf
sed -ie "s/initramfs/$ird/" /mnt/chroot/boot/grub/grub.conf

cat <<EOL > /mnt/chroot/etc/fstab
/dev/sda1               /                       ext4    defaults        1 1
tmpfs                   /dev/shm                tmpfs   defaults        0 0
devpts                  /dev/pts                devpts  gid=5,mode=620  0 0
sysfs                   /sys                    sysfs   defaults        0 0
proc                    /proc                   proc    defaults        0 0
EOL

sync

/bin/mkdir -p /mnt/chroot/root/.ssh
/bin/cp /home/$user/.ssh/authorized_keys /mnt/chroot/root/.ssh/authorized_keys
/bin/chmod 600 /mnt/chroot/root/.ssh/authorized_keys

cat <<EOL > /mnt/chroot/boot/grub/device.map
(fd0)	/dev/fd0
(hd0)	/dev/sdb
EOL

/sbin/grub-install --root-directory=/mnt/chroot /dev/sdb

cat <<EOL > /mnt/chroot/boot/grub/device.map
(fd0)	/dev/fd0
(hd0)	/dev/sda
EOL

/bin/cp -p $dirname/bootstrap /mnt/chroot/root/bootstrap

# Not sure who creates this, or why.
/bin/rm -rf /mnt/chroot/home/alan

/bin/umount /mnt/chroot/dev/shm
/bin/umount /mnt/chroot/dev/pts
/bin/umount /mnt/chroot/sys
/bin/umount /mnt/chroot/proc
/bin/umount /mnt/chroot/dev
#/bin/umount /mnt/chroot
