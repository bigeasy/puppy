#!/usr/bin/env node

function log (message, code, stderr) {
  require.paths.unshift("/puppy/common/lib/node");
  var programName = __filename.replace(/^.*\/(.*)$/, "$1");
  var branchName = __filename.replace(/^\/puppy\/(.*?)\/.*$/, "$1");
  var syslog = new (require("common/public").Syslog)({ tag: branchName + "_" + programName, pid: true });
  var context = { code: code }
  if (stderr.length > 0) {
    context.stderr = stderr;
  }
  syslog.send("err", "CATCH: " + message, context, function () {
    process.exit(code);
  });
}

var spawn = require("child_process").spawn
var program = spawn(__filename.replace(/\/([^\/]+)$/, "/$1_try"), process.argv.slice(2), { customFds: [ 0, 1, -1 ] });
stderr = "";
program.stderr.on("data", function (chunk) {
  stderr += chunk.toString();
  if (stderr.length > 4 * 1024) {
    log("Spewed over 4K to stderr.", 1, stderr);
  }
});
program.on("exit", function (code) {
  if (code != 0) {
    log("Unexpected program failure.", code, stderr);
  } else if (stderr.length) {
    log("Unexpected error output.", code, stderr);
  }
});
