#!/bin/bash

function abend()
{
    local message=$1;
    echo "error: $message" 2>&1
    exit 1
}

path=$1
file=$2

declare -A STANDBY
STANDBY=([north]=south [south]=north [east]=west [west]=east)

if [[ $(/bin/hostname) =~ ^([^.])*\.[^.]*\.([^.]*)\.([^.]*) ]]
then
    alpha=${BASH_REMATCH[1]}
    standby=${STANDBY[${BASH_REMATCH[2]}]}
    region=${BASH_REMATCH[3]}
else
    abend "hostname invalid"
fi

key=/var/lib/data/
host="$alpha.balance.$standby.$region.runpup.net"
/usr/bin/rsync -i $key -av -e 'ssh -o VerifyHostKeyDNS=yes' $path  janitor@$host:/mnt/wal/$file
