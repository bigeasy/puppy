#!/bin/bash

# Utilities.
# -------------------------------------------------------------------------- #

# Emit an error message to stderr and return a non-zero exit code.
function abend()
{
    message=$1
    echo "ERROR: $message" 1>&1
    exit 1
}

deploy=$(readlink -f $0)

. $(/usr/bin/dirname $deploy)/functions

# Installation configuration.
# -------------------------------------------------------------------------- #

# Argument validation.
[ $# -eq 1 ] && [ -d $1 ] || abend "Must provide a working directory."

# Fetch the directory name to determine the owner of the installed files.
project=$(readlink -f $1)
basename=$(basename $project)

user=$basename

# Change directory to the project directory.
cd $project

# Clear out .AppleTalk from the development machines.
# -------------------------------------------------------------------------- #
/bin/find . -name .AppleDouble -type d | /usr/bin/xargs /bin/rm -rf

# Build Node.js and CoffeeScript programs.
# -------------------------------------------------------------------------- #

umask 022

if [ -e src ]
then
    for source in $(/bin/find src -mindepth 2 -name \*.coffee)
    do
        dir=$(/usr/bin/dirname $source | sed 's/src\///')
        program=$(/bin/basename $source | sed 's/.coffee$//')
        dest=$dir/$program
        if is_dirty $source $dest
        then
            echo "Rebuildering $source."
            /bin/mkdir -p $dir
            if [ $(/bin/basename $dir) == "lib" ]
            then
                /opt/bin/coffee -c -p $source > $dest
            else
                /bin/cat $(/usr/bin/dirname $deploy)/preamble.js > $dest
                /opt/bin/coffee -c -p $source >> $dest
            fi
        fi
    done
fi

# Choose permissions.
# -------------------------------------------------------------------------- #

# Chose an owner and mode based on the project directory name. Slightly kludgey.
mode=$(/bin/cat mode 2>/dev/null || echo "550")

umask $(/usr/bin/printf "%03o" $(( ~(8#$mode) & 8#777 )))

# Install shell programs.
# -------------------------------------------------------------------------- #

# Create the mount point if it doesn't exist already.
/usr/bin/sudo mkdir -m $mode -p /puppy/$basename
/usr/bin/sudo chown $user:$user /puppy/$basename

# Install bash programs.
/usr/bin/sudo "$(dirname $deploy)/install_shell" $user $mode puppy/$basename/bin \
                                                             puppy/$basename/sbin

# Install Node.js and CoffeeScript programs.
# -------------------------------------------------------------------------- #

# Create our own custom installer.
install="/usr/bin/sudo /usr/bin/install -m $mode -o $user -g $user"

# We don't prattle on about installing node programs since they are installed
# every time we run the script.
if [ -d src -a ! -d lib ]; then
    /usr/bin/sudo /bin/mkdir -p /puppy/$basename/bin
    dest=/puppy/$basename/bin
    for coffee in $(find src/bin -name \*.coffee | /bin/sort); do
        program=$(echo $coffee | /bin/sed 's/src\/bin\/\(.*\).coffee$/\1/')
        if [ -e "bin/$program" ] && is_dirty bin/$program $dest/$program
        then
            echo "Installing $dest/$program."
            $install "bin/$program" $dest/$program
        fi
    done
fi

# Install launcher scripts for try/catch wrapped programs.
if [ -e src/try.conf ]
then
    while read file
    do
        program=$(echo $file | /bin/sed 's/^\(.*\).coffee/\1/')
        dest="/puppy/$basename/bin/${program}_try"
        if is_dirty /puppy/janitor/bin/launcher $dest
        then
            echo "Installing $dest."
            $install /puppy/janitor/bin/launcher $dest
        fi
    done < src/try.conf
fi

# Special case for worker branch, install sudo or medo launchers.
if [ $basename == "worker" ]
then
    while read line
    do
        fields=($line)
        source="src/${fields[1]}.js"
        dest="/puppy/worker/bin/${fields[0]}"
        if is_dirty $source $dest
        then
            echo "Installing $dest."
            $install $source $dest
        fi
    done < src/doers.conf
elif [ -e lib ]
then
    skip='^(.git|src|mode)'
    for lib in $(find . ! -type d | sed 's/\.\///')
    do
        if [[ $lib =~ $skip ]]
        then
            continue
        fi
        dest=/puppy/$basename/lib/node/$basename/$lib
        if is_dirty $lib $dest
        then
            /usr/bin/sudo /bin/mkdir -m $mode -p $(/usr/bin/dirname $dest)
            echo "Installing $dest."
            $install $lib $dest
        fi
    done
fi

/usr/bin/sudo chown -R root:$user /puppy/$basename
/usr/bin/sudo /sbin/restorecon -R /puppy
