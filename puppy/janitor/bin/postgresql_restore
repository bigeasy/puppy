#!/bin/bash

function abend()
{
    local message=$1;
    echo "error: $message" 2>&1
    exit 1
}

path=$1
file=$2

if [[ $(/bin/hostname) =~ ^([^.]*)\.[^.]*\.([^.]*)\.([^.]*) ]]
then
    alpha=${BASH_REMATCH[1]}
    direction=${BASH_REMATCH[2]}
    region=${BASH_REMATCH[3]}
else
    abend "hostname invalid"
fi

key=/var/lib/pgsql/.ssh/identity
host="$alpha.balance.$direction.$region.runpup.net"
/usr/bin/rsync -a -e "ssh -i $key -o VerifyHostKeyDNS=yes" postgres@$host:/mnt/wal/var/$file $path 2>/dev/null
