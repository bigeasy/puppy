#!/bin/bash -e

puppify module <<-usage
  usage: puppify install shorewall
usage

puppy_import installer
puppy_import sudoer

install_service shorewall

# Configure daemons built from source.
# -------------------------------------------------------------------------- #
non_boot iptables

install_files root 644 etc

function append_unless() {
  local file=$1; local pattern=$2; local line=$3
  grep "$pattern" "$file" > /dev/null || echo "$line" | sudo_append "$file"
}

declare -A zones
zones=([p7p1]=int [p2p1]=net [eth0]=net)
while read iface; do
  zone="${zones[$iface]}"
  append_unless /etc/shorewall/interfaces "^$zone" "$zone $iface detect dhcp,tcpflags,logmartians,nosmurfs"
  append_unless /etc/shorewall/zones "^$zone" "$zone ipv4"
  append_unless /etc/shorewall/rules "^ACCEPT  *\$FW  *$zone  *icmp" "ACCEPT \$FW $zone icmp"
  append_unless /etc/shorewall/rules "^SSH/ACCEPT  *$zone  *\$FW" "SSH/ACCEPT $zone \$FW"
  append_unless /etc/shorewall/policy "^$zone" "$zone all DROP info"
  sudo sed -i '/^all/d' /etc/shorewall/policy
  echo "all all REJECT info # Must come last." | sudo_append /etc/shorewall/policy
done < <(ifconfig | grep ^[pe] | cut -f1 -d' ')

# Enable shorewall
# -------------------------------------------------------------------------- #
sudo sed -i 's/STARTUP_ENABLED=No/STARTUP_ENABLED=Yes/' /etc/shorewall/shorewall.conf

on_boot shorewall

sudo systemctl restart shorewall.service
