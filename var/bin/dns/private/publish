#!/bin/bash

dir=$(/bin/readlink -f "$(/usr/bin/dirname $0)/../../../..")

conf=($(/bin/hostname | sed 's/.*\..*\.\(.*\)\.\(.*\)\.runpup\.com/\1 \2/'))
region="${conf[1]}"
horizontal="^east|west$"
if [[ "${conf[0]}" =~ $horizontal ]]
then
    axis="horizontal"
else
    axis="vertical"
fi

/usr/bin/sudo /bin/mkdir -p /var/lib/nsd/chroot/var/run/nsd
/usr/bin/sudo /bin/mkdir -p /var/lib/nsd/chroot/var/lib/nsd
/usr/bin/sudo /bin/mkdir -p /var/lib/nsd/chroot/etc/nsd
/usr/bin/sudo /bin/chown -R nsd:nsd /var/lib/nsd/chroot

zonefile=/var/lib/nsd/chroot/etc/nsd/$region.runpup.net.zone 
if /usr/bin/sudo [ -e $zonefile ] && [[ $(/bin/hostname) =~ [[:alpha:]]\.data\.(east|south) ]]
then
    current=($(/usr/bin/sudo /bin/sed -n 's/.*\([0-9]\{8\}\)\([0-9]\{2\}\).*; Serial.*/\1 \2/p' $zonefile))
else
    current=(00000000 01)
fi

today=$(/bin/date +%Y%m%d)
if [ "${current[0]}" == "$today" ]
then
    next="${today}"$(/usr/bin/printf '%02d\n' $((10#${current[1]} + 1)))
else
    next="${today}01"
fi

cat <<EOL | /usr/bin/sudo /usr/bin/tee $zonefile > /dev/null
\$TTL    3h
\$ORIGIN $region.runpup.net
@       IN      SOA     ns1.runpup.net. alan.prettyrobots.com. (
                          ${next}    ; Serial
                          3h            ; Refresh after 3 hours
                          1h            ; Retry after 1 hour
                          1w            ; Expire after 1 week
                          1h )          ; Negative caching TTL of 1 day
;
EOL

user_seen=0
master=$($dir/var/bin/dns/private/address --region $region --axis $axis | while read line
do
    pair=($line)
    host=$(echo ${pair[0]} | sed 's/\.'$region'\.runpup\.com//')
    echo "$host IN A ${pair[1]}" | /usr/bin/sudo /usr/bin/tee -a $zonefile > /dev/null
    /usr/bin/ssh-keygen -r $host -f /mnt/config/var/${pair[0]}/etc/ssh/ssh_host_rsa_key | \
        /usr/bin/sudo /usr/bin/tee -a $zonefile > /dev/null
    is_user=0
    public="^\w+\.data"
    user="^\w+\.user\.(east|south)"
    if [[ ${pair[0]} =~ $user ]] && [ $user_seen -eq 0 ]
    then
        user_seen=1
        is_user=1
    fi
    if [ -z "$master" ] && [[ ${pair[0]} =~ [[:alpha:]]\.data\.(east|south) ]]
    then
        master=${pair[0]}
        echo $master
        echo "@ IN NS ns1" | /usr/bin/sudo /usr/bin/tee -a $zonefile > /dev/null
        echo "ns1 IN A ${pair[1]}" | /usr/bin/sudo /usr/bin/tee -a $zonefile > /dev/null
    fi
    if [ $is_user -eq 1 ] || [[ ${pair[0]} =~ $public ]]
    then
        echo "@ IN NS ns.$host" | /usr/bin/sudo /usr/bin/tee -a $zonefile > /dev/null
        echo "ns.$host IN A ${pair[1]}" | /usr/bin/sudo /usr/bin/tee -a $zonefile > /dev/null
    fi
done)

$dir/bin/loopback/mount /dev/loop5 /mnt/dns
ksk=$(/bin/basename $(/bin/ls /mnt/dns/var/$region.runpup.net/current/ksk/*.key) .key)
zsk=$(/bin/basename $(/bin/ls /mnt/dns/var/$region.runpup.net/current/zsk/*.key) .key)
/usr/bin/sudo /usr/bin/ldns-signzone $zonefile \
    /mnt/dns/var/$region.runpup.net/current/ksk/$ksk \
    /mnt/dns/var/$region.runpup.net/current/zsk/$zsk
$dir/bin/loopback/delete /mnt/dns

/usr/bin/sudo /bin/mkdir -p /var/run/nsd
/usr/bin/sudo /bin/chown -R nsd:nsd /var/lib/nsd/chroot
/usr/bin/sudo /bin/chmod -R gou+x /var/lib/nsd/chroot
/usr/bin/sudo /bin/chmod -R o-rwx /var/lib/nsd/chroot

/usr/bin/sudo /bin/systemctl restart nsd.service
/usr/bin/sudo /usr/sbin/nsdc rebuild > /dev/null
/usr/bin/sudo /usr/sbin/nsdc reload > /dev/null
if [ "$master" = $(/bin/hostname) ]
then
    /usr/bin/sudo /usr/sbin/nsdc notify > /dev/null
fi

#$dir/loopback/snapshot /mnt/dns
