#!/bin/bash

conf=($(/bin/hostname | sed 's/.*\..*\.\(.*\)\.\(.*\)\.runpup\.com/\1 \2/'))
region="${conf[1]}"
if [[ "${conf[0]}" =~ ^east|west$ ]]
then
    axis="horizontal"
else
    axis="vertical"
fi

dir=$(/bin/readlink -f $(/usr/bin/dirname $0))
$dir/address --region $region --axis $axis | while read line
do
    pair=($line)
    public="^\w+\.user"
    if [[ ${pair[0]} =~ $public ]]
    then
        host=$(echo ${pair[0]} | sed 's/\.runpup\.com//')
        /usr/bin/sudo /usr/bin/ssh-keygen -r $host -f /mnt/config/var/${pair[0]}/etc/ssh/ssh_host_rsa_key
        echo "$host IN A ${pair[1]}"
    fi
done
