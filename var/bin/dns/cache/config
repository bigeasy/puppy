#!/bin/bash

dir=$(/bin/readlink -f "$(/usr/bin/dirname $0)/../../../..")
.  $dir/var/bin/dns/configuration

bin/loopback/mount /dev/loop5 /mnt/dns
cat /mnt/dns/var/$region.runpup.net/current/ksk/*.ds /mnt/dns/var/$region.runpup.net/current/ksk/*.key | \
    /usr/bin/sudo /usr/bin/tee /etc/unbound/runpup.net.key > /dev/null
bin/loopback/delete /mnt/dns

cat <<EOL | /usr/bin/sudo /usr/bin/tee /etc/unbound/unbound.conf > /dev/null
server:
    verbosity: 1
    statistics-interval: 0
    statistics-cumulative: no
    extended-statistics: yes
    num-threads: 2
    interface-automatic: no
    interface: 127.0.0.1
    chroot: ""
    username: "unbound"
    directory: "/etc/unbound"
    log-time-ascii: yes
    pidfile: "/var/run/unbound/unbound.pid"
    harden-glue: yes
    harden-dnssec-stripped: yes
    harden-referral-path: yes
    use-caps-for-id: yes
    unwanted-reply-threshold: 10000000
    prefetch: yes
    prefetch-key: yes
    dlv-anchor-file: "/etc/unbound/dlv.isc.org.key"
    trusted-keys-file: /etc/unbound/root.key
    val-clean-additional: yes
    val-permissive-mode: no
    val-log-level: 1
    trust-anchor-file: "/etc/unbound/runpup.net.key"
remote-control:
    control-enable: yes
    server-key-file: "/etc/unbound/unbound_server.key"
    server-cert-file: "/etc/unbound/unbound_server.pem"
    control-key-file: "/etc/unbound/unbound_control.key"
    control-cert-file: "/etc/unbound/unbound_control.pem"
stub-zone:
    name: "$region.runpup.net"
    stub-prime: yes
    stub-host: "ns1.runpup.com"
    stub-host: "ns4.runpup.com"
EOL
