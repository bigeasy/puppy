#!/bin/bash

if [ $(/usr/bin/id -u) -ne 0 ]
then
    echo "Must run as root." 1>&2
    exit 1
fi

function abend()
{
    local message=$1
    echo "error: $message." 1>&2
}

dir=$(/bin/readlink -f "$(/usr/bin/dirname $0)/../../../..")
$dir/var/bin/pg/config

cat <<EOL >> /var/lib/pgsql/data/postgresql.conf
hot_standby = on
EOL

[[ $(/bin/hostname) =~ ^([^.]*)\.[^.]*\.([^.]*)\.([^.]*)\.(.*)$ ]] || abend "bad hostname"

alpha=${BASH_REMATCH[1]};   direction=${BASH_REMATCH[2]}
region=${BASH_REMATCH[3]};  domain=${BASH_REMATCH[4]}

declare -A PRIMARY
PRIMARY=([north]=south [south]=north [east]=west [west]=east)
primary="$alpha.data.${PRIMARY[$direction]}.$region.$domain"

declare -A AXES
AXES=([north]=vertical [south]=vertical [east]=horizontal [west]=horizontal)
ip=$($dir/var/bin/dns/private/address --region $region --axis ${AXES[$direction]} | while read line
do
    pair=($line)
    if [ ${pair[0]} == $primary ]
    then
        echo ${pair[1]}
    fi
done)

cat <<EOL >> /var/lib/pgsql/data/recovery.conf
standby_mode = 'on'
primary_conninfo = 'host=$ip port=5432 user=postgres'
trigger_file = '/var/lib/pgsql/.failover'
restore_command = '/puppy/janitor/bin/postgresql_restore %p %f'
archive_cleanup_command = '/puppy/janitor/bin/postgresql_cleanup %r'
EOL
